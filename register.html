<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Register</title>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body style="background: var(--bg-color); color: var(--text-color)">
    <div
      class="container d-flex justify-content-center align-items-center"
      style="min-height: 100vh"
    >
      <div
        class="card p-4"
        style="background: var(--second-bg-color); min-width: 350px"
      >
        <h2 class="mb-4 text-center" style="color: var(--main-color)">
          Admin Register
        </h2>
        <form id="adminRegisterForm">
          <div class="mb-3">
            <label for="registerName" class="form-label">Nama</label>
            <input
              type="text"
              class="form-control"
              id="registerName"
              required
            />
          </div>
          <div class="mb-3">
            <label for="registerEmail" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="registerEmail"
              required
            />
          </div>
          <div class="mb-3">
            <label for="registerPassword" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="registerPassword"
              required
            />
          </div>
          <button type="submit" class="btn btn-success w-100">Register</button>
          <div id="registerError" class="mt-2 text-danger"></div>
        </form>
        <div class="mt-3 text-center">
          <a href="login.html" style="color: var(--main-color)"
            >Sudah punya akun? Login</a
          >
        </div>
      </div>
    </div>
    <script>
      // Ganti dengan project Supabase kamu
      const SUPABASE_URL = "https://swsqdksyabjbafmuxljx.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3c3Fka3N5YWJqYmFmbXV4bGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODU2MDEsImV4cCI6MjA3MTc2MTYwMX0.P1vKqCAkQD5F9O5mBqph0z-eyJ508I8-lOJs_0muchk";
      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY,
      );

      let isSubmitting = false; // Prevent double submission

      document
        .getElementById("adminRegisterForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Prevent double submission
          if (isSubmitting) return;
          isSubmitting = true;

          const submitBtn = this.querySelector("button[type='submit']");
          const originalBtnText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Loading...";

          const name = document.getElementById("registerName").value;
          const email = document.getElementById("registerEmail").value;
          const password = document.getElementById("registerPassword").value;

          // Hash password dengan SHA-256
          async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await window.crypto.subtle.digest(
              "SHA-256",
              data,
            );
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray
              .map((b) => b.toString(16).padStart(2, "0"))
              .join("");
          }

          try {
            // Register ke Supabase Auth
            const { data, error } = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (error) {
              document.getElementById("registerError").textContent =
                error.message;
              isSubmitting = false;
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
              return;
            }

            // Hash password dan simpan ke tbl_users hanya jika user sudah terdaftar
            const hashedPassword = await hashPassword(password);
            const { error: insertError } = await supabaseClient
              .from("tbl_users")
              .insert([{ email: email, nama: name, password: hashedPassword }]);
            if (insertError) {
              document.getElementById("registerError").textContent =
                "Register Auth success, tapi gagal simpan ke database: " +
                insertError.message;
              isSubmitting = false;
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
            } else {
              document.getElementById("registerError").textContent = "";
              Swal.fire(
                "Register Success",
                "Please check your email to verify your account.",
                "success",
              ).then(() => {
                window.location.href = "login.html";
              });
            }
          } catch (err) {
            console.error("Register error:", err);
            document.getElementById("registerError").textContent =
              "Terjadi kesalahan. Silakan coba lagi.";
            isSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
          }
        });
    </script>
  </body>
</html>
