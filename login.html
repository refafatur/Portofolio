<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Login</title>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="login.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div
      class="container d-flex justify-content-center align-items-center login-container"
    >
      <div class="card p-4 shadow login-card">
        <!-- <div class="text-center mb-3">
          <img src="image/logo.png" alt="Logo" class="login-logo" />
          <div class="login-title">Pyy</div>
        </div> -->
        <h2 class="mb-4 text-center login-header">Login</h2>
        <form id="adminLoginForm">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="loginEmail" required />
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="loginPassword"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary w-100">Login</button>
          <div id="loginError" class="mt-2 text-danger"></div>
        </form>
        <div class="mt-3 text-center">
          Belum punya akun?
          <a href="register.html" class="login-link">Register</a>
        </div>
      </div>
    </div>
    <script>
      // Ganti dengan project Supabase kamu
      const SUPABASE_URL = "https://swsqdksyabjbafmuxljx.supabase.co/";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3c3Fka3N5YWJqYmFmbXV4bGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODU2MDEsImV4cCI6MjA3MTc2MTYwMX0.P1vKqCAkQD5F9O5mBqph0z-eyJ508I8-lOJs_0muchk";
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let isSubmitting = false; // Prevent double submission

      document
        .getElementById("adminLoginForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Prevent double submission
          if (isSubmitting) return;
          isSubmitting = true;

          const submitBtn = this.querySelector("button[type='submit']");
          const originalBtnText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Loading...";

          const email = document.getElementById("loginEmail").value;
          const password = document.getElementById("loginPassword").value;

          try {
            // Query tbl_users for matching email only
            const { data, error } = await sb
              .from("tbl_users")
              .select("*")
              .eq("email", email);
            if (error || !data || data.length === 0) {
              document.getElementById("loginError").textContent =
                "Email atau password salah.";
              isSubmitting = false;
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
              return;
            }
            // Hash password input dengan SHA-256
            async function hashPassword(password) {
              const encoder = new TextEncoder();
              const data = encoder.encode(password);
              const hashBuffer = await window.crypto.subtle.digest(
                "SHA-256",
                data,
              );
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              return hashArray
                .map((b) => b.toString(16).padStart(2, "0"))
                .join("");
            }
            const hashedInput = await hashPassword(password);
            if (hashedInput !== data[0].password) {
              document.getElementById("loginError").textContent =
                "Email atau password salah.";
              isSubmitting = false;
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
              return;
            }
            // Simpan nama admin ke localStorage
            localStorage.setItem("adminName", data[0].nama || "Admin");
            document.getElementById("loginError").textContent = "";
            Swal.fire("Login Success", "Welcome, Admin!", "success").then(
              () => {
                window.location.href = "dashboard.html";
              },
            );
          } catch (err) {
            console.error("Login error:", err);
            document.getElementById("loginError").textContent =
              "Terjadi kesalahan. Silakan coba lagi.";
            isSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
          }
        });
    </script>
  </body>
</html>
