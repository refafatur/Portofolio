<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gallery - Portfolio Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="dashboard-new.css" />
  <link rel="icon" href="image/logo.png" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .file-upload {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
      border: 2px dashed var(--gray-300);
      border-radius: 12px;
      background: var(--gray-50);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-upload input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-upload i {
      font-size: 2rem;
      color: var(--gray-400);
      margin-bottom: 8px;
    }

    .file-upload span {
      color: var(--gray-500);
      font-size: 0.9rem;
    }

    .file-preview {
      max-width: 100%;
      max-height: 150px;
      border-radius: 8px;
      margin-top: 12px;
      display: none;
    }

    .file-name {
      font-size: 0.85rem;
      color: var(--primary);
      margin-top: 8px;
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', function (e) {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'u') ||
        (e.ctrlKey && e.key === 's')) { e.preventDefault(); return false; }
    });
  </script>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">R</div>
      <span class="logo-text">Portfolio Admin</span>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Main Menu</div>
        <a href="dashboard.html" class="nav-item"><i class="bi bi-grid-1x2"></i><span>Dashboard</span></a>
        <a href="project.html" class="nav-item"><i class="bi bi-folder"></i><span>Projects</span></a>
        <a href="certificate.html" class="nav-item"><i class="bi bi-award"></i><span>Certificates</span></a>
        <a href="galeri.html" class="nav-item active"><i class="bi bi-images"></i><span>Gallery</span></a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Quick Links</div>
        <a href="index.html" class="nav-item" target="_blank"><i class="bi bi-globe"></i><span>View Portfolio</span></a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a href="#" class="nav-item" id="logoutBtn"><i class="bi bi-box-arrow-left"></i><span>Logout</span></a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="dashboard-header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle"><i class="bi bi-list"></i></button>
        <h1 class="page-title">Gallery</h1>
      </div>
      <div class="header-right">
        <div class="user-profile">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-info">
            <span class="user-name" id="userName">Admin</span>
            <span class="user-role">Administrator</span>
          </div>
        </div>
      </div>
    </header>

    <div class="dashboard-content">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Manage Gallery</h3>
          <button class="btn btn-primary" onclick="openModal()">
            <i class="bi bi-plus"></i> Add Image
          </button>
        </div>
        <div class="card-body">
          <div class="items-grid" id="galleryGrid"></div>
          <div class="empty-state" id="emptyState" style="display:none;">
            <div class="empty-icon"><i class="bi bi-images"></i></div>
            <h3 class="empty-title">No Images Yet</h3>
            <p class="empty-text">Add your first image to showcase your gallery</p>
            <button class="btn btn-primary" onclick="openModal()"><i class="bi bi-plus"></i> Add Image</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal" id="galleryModal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Add Image</h3>
        <button class="modal-close" onclick="closeModal()"><i class="bi bi-x"></i></button>
      </div>
      <div class="modal-body">
        <form id="galleryForm">
          <input type="hidden" id="imageId" />
          <input type="hidden" id="existingFoto" />
          <div class="form-group">
            <label class="form-label">Upload Foto</label>
            <div class="file-upload" id="fotoUpload">
              <input type="file" id="imageFoto" accept="image/*" onchange="previewFile(this)" />
              <i class="bi bi-cloud-upload"></i>
              <span>Click or drag image here</span>
              <img id="fotoPreview" class="file-preview" />
              <div id="fileName" class="file-name"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveImage()">Save Image</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://swsqdksyabjbafmuxljx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3c3Fka3N5YWJqYmFmbXV4bGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODU2MDEsImV4cCI6MjA3MTc2MTYwMX0.P1vKqCAkQD5F9O5mBqph0z-eyJ508I8-lOJs_0muchk';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const adminName = localStorage.getItem('adminName') || 'Admin';
    document.getElementById('userName').textContent = adminName;
    document.getElementById('userAvatar').textContent = adminName.charAt(0).toUpperCase();

    document.getElementById('menuToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('adminName');
      window.location.href = 'login.html';
    });

    // Preview file before upload
    function previewFile(input) {
      const preview = document.getElementById('fotoPreview');
      const fileName = document.getElementById('fileName');

      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
        fileName.textContent = input.files[0].name;
      }
    }

    // Upload file to Supabase Storage
    async function uploadFile(file, folder) {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
      const filePath = `${folder}/${fileName}`;

      const { data, error } = await sb.storage
        .from('Portofolio')
        .upload(filePath, file);

      if (error) {
        console.error('Upload error:', error);
        throw error;
      }

      const { data: urlData } = sb.storage
        .from('Portofolio')
        .getPublicUrl(filePath);

      return urlData.publicUrl;
    }

    async function loadGallery() {
      const { data, error } = await sb.from('tbl_galeris').select('*').order('id', { ascending: false });
      const grid = document.getElementById('galleryGrid');
      const empty = document.getElementById('emptyState');

      if (!data || data.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      grid.innerHTML = data.map(g => `
          <div class="item-card">
            <img src="${g.foto || 'https://via.placeholder.com/400x200'}" alt="Gallery Image" class="item-image" />
            <div class="item-content">
              <h4 class="item-title">Gallery Image #${g.id}</h4>
              <p class="item-description"><a href="${g.foto}" target="_blank">View Full Image</a></p>
            </div>
            <div class="item-actions">
              <button class="btn btn-secondary btn-sm" onclick="editImage(${g.id})"><i class="bi bi-pencil"></i> Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteImage(${g.id})"><i class="bi bi-trash"></i> Delete</button>
            </div>
          </div>
        `).join('');
    }

    function openModal(image = null) {
      document.getElementById('galleryModal').classList.add('show');
      document.getElementById('modalTitle').textContent = image ? 'Edit Image' : 'Add Image';
      document.getElementById('fotoPreview').style.display = 'none';
      document.getElementById('fileName').textContent = '';
      document.getElementById('imageFoto').value = '';

      if (image) {
        document.getElementById('imageId').value = image.id;
        document.getElementById('existingFoto').value = image.foto || '';
        if (image.foto) {
          document.getElementById('fotoPreview').src = image.foto;
          document.getElementById('fotoPreview').style.display = 'block';
          document.getElementById('fileName').textContent = 'Current image (select new to replace)';
        }
      } else {
        document.getElementById('galleryForm').reset();
        document.getElementById('imageId').value = '';
        document.getElementById('existingFoto').value = '';
      }
    }

    function closeModal() {
      document.getElementById('galleryModal').classList.remove('show');
    }

    async function editImage(id) {
      const { data } = await sb.from('tbl_galeris').select('*').eq('id', id).single();
      if (data) openModal(data);
    }

    async function saveImage() {
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Saving...';

      try {
        const id = document.getElementById('imageId').value;
        const fileInput = document.getElementById('imageFoto');
        let fotoUrl = document.getElementById('existingFoto').value;

        // Upload new file if selected
        if (fileInput.files && fileInput.files[0]) {
          fotoUrl = await uploadFile(fileInput.files[0], 'gallery');
        }

        if (!fotoUrl) {
          Swal.fire('Error', 'Please select an image to upload', 'error');
          saveBtn.disabled = false;
          saveBtn.innerHTML = 'Save Image';
          return;
        }

        const imageData = {
          foto: fotoUrl
        };

        let error;
        if (id) {
          ({ error } = await sb.from('tbl_galeris').update(imageData).eq('id', id));
        } else {
          ({ error } = await sb.from('tbl_galeris').insert([imageData]));
        }

        if (error) {
          Swal.fire('Error', error.message, 'error');
        } else {
          Swal.fire('Success', id ? 'Image updated!' : 'Image added!', 'success');
          closeModal();
          loadGallery();
        }
      } catch (err) {
        Swal.fire('Error', 'Failed to upload file: ' + err.message, 'error');
      }

      saveBtn.disabled = false;
      saveBtn.innerHTML = 'Save Image';
    }

    async function deleteImage(id) {
      const result = await Swal.fire({
        title: 'Delete Image?',
        text: 'This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Delete'
      });

      if (result.isConfirmed) {
        const { error } = await sb.from('tbl_galeris').delete().eq('id', id);
        if (error) {
          Swal.fire('Error', error.message, 'error');
        } else {
          Swal.fire('Deleted', 'Image deleted.', 'success');
          loadGallery();
        }
      }
    }

    loadGallery();
  </script>

  <button class="theme-toggle" id="themeToggle"><i class="bi bi-moon-fill"></i><i class="bi bi-sun-fill"></i></button>
  <script>
    (function () {
      const t = document.getElementById('themeToggle'), h = document.documentElement;
      if (localStorage.getItem('theme') === 'dark') h.setAttribute('data-theme', 'dark');
      t.addEventListener('click', () => { const n = h.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; h.setAttribute('data-theme', n); localStorage.setItem('theme', n); });
    })();
  </script>
</body>

</html>